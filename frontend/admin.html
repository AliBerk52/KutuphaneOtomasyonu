<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Akıllı Kütüphane - Admin Paneli</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f7fb;
      color: #24304a;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .admin-header {
      background: #245cc6;
      color: #fff;
      padding: 2.5rem 0 2rem 0;
      text-align: center;
      box-shadow: 0 2px 14px #2952841a;
    }
    .admin-header h1 {
      margin: 0 0 0.45em 0;
      font-size: 2.4em;
      letter-spacing: 1.3px;
      font-weight: 700;
    }
    .admin-header p {
      font-size: 1.11em;
      font-weight: 400;
      opacity: 0.92;
      margin-bottom: 0.5em;
    }
    .admin-section {
      max-width: 960px;
      margin: 2rem auto 0 auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 3px 22px #ddeafc33;
      padding: 2.3rem 2.8rem 2.7rem 2.8rem;
      display: flex;
      flex-direction: column;
      gap: 2.6rem;
      align-items: stretch;
    }
    .admin-panel-heading {
      font-size: 1.21em;
      margin-bottom: 0.7em;
      color: #245cc6;
      font-weight: 650;
      letter-spacing: .02em;
    }
    table.admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.3em;
      border-radius: 8px;
    }
    table.admin-table th, table.admin-table td {
      border: 1px solid #e8eef8;
      padding: 0.68em;
      text-align: left;
      font-size: 1em;
    }
    table.admin-table th {
      background: #eef5ff;
      font-weight: 700;
      color: #245cc6;
    }
    table.admin-table td {
      background: #fbfcfd;
    }
    .msg {
      padding: 0.7em 1.1em;
      margin-bottom: 1em;
      border-radius: 9px;
      font-size: 1.03em;
      display: inline-block;
    }
    .msg-success {
      background: #e3fae7;
      color: #26793c;
      border: 1px solid #92e8ba;
    }
    .msg-error {
      background: #ffebe9;
      color: #ae2b31;
      border: 1px solid #ffb7bc;
    }
    .add-book-form {
      display: flex;
      gap: 0.85em;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-bottom: 1.5em;
    }
    .add-book-form input, .add-book-form select {
      padding: 0.51em 0.81em;
      border: 1px solid #b2cdf7;
      border-radius: 6px;
      font-size: 1em;
      background: #f7fbff;
    }
    .add-book-form input[type="number"] {
      width: 90px;
    }
    .add-book-form button {
      background: #245cc6;
      color: #fff;
      border: none;
      padding: 0.53em 1.6em;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 650;
      transition: background 0.2s;
    }
    .add-book-form button:hover {
      background: #18427e;
    }
    .admin-actions button {
      background: #e15c42;
      color: #fff;
      border: none;
      padding: 0.43em 1.25em;
      border-radius: 5px;
      font-size: 0.99em;
      cursor: pointer;
      margin-right: 0.35em;
      transition: background 0.2s;
    }
    .admin-actions button:last-child {
      margin-right: 0;
    }
    .admin-actions button:hover {
      background: #b54524;
    }
    .logout-btn {
      background: #8893b0;
      color: #fff;
      border: none;
      padding: 0.47em 1.3em;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      margin-top: 0.5em;
      float: right;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .logout-btn:hover {
      background: #596180;
    }
    @media (max-width: 770px) {
      .admin-section { padding: 1.15rem 1.1rem; }
      .add-book-form { flex-direction: column; align-items: stretch; gap:1em; }
      .logout-btn { float: none; display: block; width: 87%; margin: 0.9em auto 0 auto; }
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <h1>Admin Paneli</h1>
    <p>Sistemdeki kitapları yönetin, kullanıcı listelerini ve admin sınıfı kitaplarını burada düzenleyin.</p>
  </div>
  <div class="admin-section">
    <div>
      <div class="admin-panel-heading">Kitap Ekle / Düzenle</div>
      <form class="add-book-form" id="addBookForm">
        <input type="text" id="title" placeholder="Kitap adı" required />
        <input type="text" id="author" placeholder="Yazar" required />
        <input type="number" id="year" placeholder="Yıl" min="0" />
        <input type="hidden" id="editingBookId" />
        <button type="submit" id="addBookBtn">Ekle</button>
        <button type="button" id="cancelEditBtn" style="display:none; background:#bbb;color:#233;">Vazgeç</button>
      </form>
      <div id="addBookMsg"></div>
    </div>
    <div>
      <div class="admin-panel-heading">Kitap Listesi</div>
      <table class="admin-table" id="booksTable">
        <thead>
          <tr>
            <th>Başlık</th>
            <th>Yazar</th>
            <th>Yıl</th>
            <th>Durum</th>
            <th>İşlemler</th>
          </tr>
        </thead>
        <tbody>
          <!-- Kitaplar buraya gelecek -->
        </tbody>
      </table>
      <div id="bookMsg"></div>
    </div>
    <div>
      <div class="admin-panel-heading">Admin Sınıfı Kitap Listesi</div>
      <table class="admin-table" id="adminClassBooksTable">
        <thead>
          <tr>
            <th>Başlık</th>
            <th>Yazar</th>
            <th>Yıl</th>
            <th>Durum</th>
            <th>İşlemler</th>
          </tr>
        </thead>
        <tbody>
          <!-- Admin kitapları buraya gelecek -->
        </tbody>
      </table>
      <div id="adminClassBookMsg"></div>
    </div>
    <div>
      <div class="admin-panel-heading">Tüm Kullanıcılar</div>
      <table class="admin-table" id="usersTable">
        <thead>
          <tr>
            <th>Kullanıcı Adı</th>
            <th>Email</th>
            <th>Admin?</th>
          </tr>
        </thead>
        <tbody>
          <!-- Kullanıcılar buraya gelecek -->
        </tbody>
      </table>
      <div id="userMsg"></div>
    </div>
    <button class="logout-btn" onclick="logout()">Çıkış Yap</button>
  </div>
  <script>
    let books = [];
    let users = [];
    let adminClassBooks = [];
    let isEditing = false;

    function showMsg(target, msg, success=true) {
      const el = document.getElementById(target);
      if (!msg) {
        el.innerHTML = '';
        return;
      }
      el.innerHTML = `<span class="msg ${success ? 'msg-success' : 'msg-error'}">${msg}</span>`;
    }

    async function fetchBooks() {
      showMsg('bookMsg','Kitaplar yükleniyor...');
      try {
        const resp = await fetch('/api/books');
        if (!resp.ok) throw new Error();
        books = await resp.json();
        renderBooks();
        showMsg('bookMsg','');
      } catch (e) {
        showMsg('bookMsg','Kitaplar yüklenemedi.', false);
      }
    }

    function renderBooks() {
      const tbody = document.querySelector("#booksTable tbody");
      tbody.innerHTML = '';
      if (!books.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5">Hiç kitap yok.</td>`;
        tbody.append(tr);
        return;
      }
      for (const b of books) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${b.title}</td>
          <td>${b.author}</td>
          <td>${b.year || '-'}</td>
          <td>${b.available ? "Mevcut" : "Ödünçte"}</td>
          <td class="admin-actions">
            <button onclick="editBook('${b.id}')">Düzenle</button>
            <button onclick="deleteBook('${b.id}')">Sil</button>
          </td>
        `;
        tbody.append(tr);
      }
    }

    // Admin sınıfı için kitapları getir
    async function fetchAdminClassBooks() {
      showMsg('adminClassBookMsg', 'Admin sınıfı kitapları yükleniyor...');
      try {
        const resp = await fetch('/api/books/admin');
        if (!resp.ok) throw new Error();
        adminClassBooks = await resp.json();
        renderAdminClassBooks();
        showMsg('adminClassBookMsg', '');
      } catch (e) {
        showMsg('adminClassBookMsg', 'Admin sınıfı kitaplar yüklenemedi.', false);
      }
    }

    function renderAdminClassBooks() {
      const tbody = document.querySelector("#adminClassBooksTable tbody");
      tbody.innerHTML = '';
      if (!adminClassBooks.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5">Hiç admin sınıfı kitabı yok.</td>`;
        tbody.append(tr);
        return;
      }
      for (const b of adminClassBooks) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${b.title}</td>
          <td>${b.author}</td>
          <td>${b.year || '-'}</td>
          <td>${typeof b.available !== "undefined" ? (b.available ? "Mevcut" : "Ödünçte") : "-"}</td>
          <td class="admin-actions">
            <button onclick="editAdminClassBook('${b.id}')">Düzenle</button>
          </td>
        `;
        tbody.append(tr);
      }
    }

    async function deleteBook(bookId) {
      if (!confirm("Bu kitabı silmek istediğinize emin misiniz?")) return;
      showMsg('bookMsg', "Siliniyor...");
      try {
        const resp = await fetch(`/api/books/${bookId}`, {method: "DELETE"});
        const data = await resp.json();
        if (!resp.ok) {
          showMsg('bookMsg', data.error || "Silinemedi.", false);
          return;
        }
        showMsg('bookMsg', "Kitap silindi!");
        await fetchBooks();
        await fetchAdminClassBooks();
        resetEditForm();
      } catch (e) {
        showMsg('bookMsg', "Bağlantı hatası.", false);
      }
    }

    document.getElementById("addBookForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const title = document.getElementById("title").value.trim();
      const author = document.getElementById("author").value.trim();
      const year = document.getElementById("year").value ? parseInt(document.getElementById("year").value) : null;
      const editingId = document.getElementById("editingBookId").value;
      if (!title || !author) {
        showMsg('addBookMsg', "Tüm alanları doldurun.", false);
        return;
      }
      if (editingId) {
        // Düzenleme modunda
        showMsg('addBookMsg', "Güncelleniyor...");
        try {
          const resp = await fetch(`/api/books/${editingId}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({title, author, year}),
          });
          const data = await resp.json();
          if (!resp.ok) {
            showMsg('addBookMsg', data.error || "Güncellenemedi.", false);
            return;
          }
          showMsg('addBookMsg', "Kitap güncellendi!");
          document.getElementById("addBookForm").reset();
          resetEditForm();
          await fetchBooks();
          await fetchAdminClassBooks();
        } catch (e) {
          showMsg('addBookMsg', "Bağlantı hatası.", false);
        }
      } else {
        // Ekleme modunda
        showMsg('addBookMsg', "Ekleniyor...");
        try {
          const resp = await fetch('/api/books', {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({title, author, year}),
          });
          const data = await resp.json();
          if (!resp.ok) {
            showMsg('addBookMsg', data.error || "Eklenemedi.", false);
            return;
          }
          showMsg('addBookMsg', "Kitap eklendi!");
          document.getElementById("addBookForm").reset();
          await fetchBooks();
          await fetchAdminClassBooks();
        } catch (e) {
          showMsg('addBookMsg', "Bağlantı hatası.", false);
        }
      }
    });

    document.getElementById("cancelEditBtn").addEventListener("click", function() {
      resetEditForm();
    });

    function editBook(bookId) {
      const book = books.find(b => b.id === bookId);
      if (!book) return;
      document.getElementById("title").value = book.title;
      document.getElementById("author").value = book.author;
      document.getElementById("year").value = book.year || '';
      document.getElementById("editingBookId").value = bookId;
      document.getElementById("addBookBtn").textContent = "Güncelle";
      document.getElementById("cancelEditBtn").style.display = "";
      isEditing = true;
      window.scrollTo({top: 0, behavior: "smooth"});
      showMsg('addBookMsg', "Düzenleme modunda", true);
    }

    function resetEditForm() {
      document.getElementById("addBookForm").reset();
      document.getElementById("editingBookId").value = "";
      document.getElementById("addBookBtn").textContent = "Ekle";
      document.getElementById("cancelEditBtn").style.display = "none";
      isEditing = false;
      showMsg('addBookMsg', "");
    }

    // Admin sınıfı kitaplarını düzenleme için örnek
    function editAdminClassBook(bookId) {
      const book = adminClassBooks.find(b => b.id === bookId);
      if (!book) return;
      document.getElementById("title").value = book.title;
      document.getElementById("author").value = book.author;
      document.getElementById("year").value = book.year || '';
      document.getElementById("editingBookId").value = bookId;
      document.getElementById("addBookBtn").textContent = "Güncelle";
      document.getElementById("cancelEditBtn").style.display = "";
      isEditing = true;
      window.scrollTo({top: 0, behavior: "smooth"});
      showMsg('addBookMsg', "Admin sınıfı kitabı düzenleme modunda", true);
    }

    async function fetchUsers() {
      showMsg('userMsg', "Kullanıcılar yükleniyor...");
      try {
        const resp = await fetch('/api/users');
        if (!resp.ok) throw new Error();
        users = await resp.json();
        renderUsers();
        showMsg('userMsg', "");
      } catch (e) {
        showMsg('userMsg', "Kullanıcılar yüklenemedi.", false);
      }
    }

    function renderUsers() {
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = '';
      if (!users.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3">Hiç kullanıcı yok.</td>`;
        tbody.append(tr);
        return;
      }
      for (const u of users) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.email}</td>
          <td>${u.is_admin ? 'Evet' : 'Hayır'}</td>
        `;
        tbody.append(tr);
      }
    }

    async function logout() {
      try {
        await fetch('/api/logout', {method:"POST"});
      } catch (e) {}
      window.location.href = '/login.html';
    }

    window.addEventListener('DOMContentLoaded', async function() {
      await fetchBooks();
      await fetchUsers();
      await fetchAdminClassBooks();
    });
  </script>
</body>
</html>
